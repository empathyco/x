<template>
  <div class="x-flex x-flex-col x-gap-24">
    <FacetsProvider :facets="staticFacets" groupId="price" />
    <ClearFilters />
    <SelectedFiltersList>
      <template #default="{ filter }">
        <SimpleFilter :filter="filter" class="x-facet-filter-success">
          <template #label>{{ filter.label ?? filter.id }}</template>
        </SimpleFilter>
      </template>
    </SelectedFiltersList>

    <!-- Facets -->
    <Facets class="x-gap-24">
      <!--  Editable Number Price Range Facet    -->
      <template #editable-number-range-facet="{ facet }">
        <BaseHeaderTogglePanel
          :data-test="facet.label"
          class="x-border-0 x-border-b x-border-neutral-10"
        >
          <template #header-content>
            <span :data-test="facet.label" class="x-truncate">{{ facet.label }}</span>
            <ChevronDown />
          </template>
          <!-- Filters -->
          <EditableNumberPriceRangeFilter :filter="facet.filters[0]" />
        </BaseHeaderTogglePanel>
      </template>

      <!--  Hierarchical Facet    -->
      <template #hierarchical-facet="{ facet }">
        <BaseHeaderTogglePanel headerClass="x-w-full x-flex x-justify-between x-py-8">
          <template #header-content>
            <span class="x-truncate">{{ facet.label }}</span>
            <ChevronDown />
          </template>
          <!-- Filters -->
          <SlicedFilters max="4" :filters="facet.filters">
            <FiltersList v-slot="{ filter }">
              <HierarchicalFilter
                :filter="filter"
                :data-test="`${facet.label}-filter`"
                childrenFiltersClass="x-ml-16"
              />
            </FiltersList>
          </SlicedFilters>
        </BaseHeaderTogglePanel>
      </template>

      <!--  Range Facet    -->
      <template #number-range-facet="{ facet }">
        <BaseHeaderTogglePanel headerClass="x-w-full x-flex x-justify-between x-py-8">
          <template #header-content>
            <span :data-test="facet.label" class="x-truncate">{{ facet.label }}</span>
            <ChevronDown />
          </template>
          <!-- Filters -->
          <ExcludeFiltersWithNoResults :filters="facet.filters">
            <SortedFilters>
              <SlicedFilters
                :max="controls.slicedFilters.max"
                :data-test="`${facet.label}-sliced-filters`"
              >
                <SelectedFilters #default="{ selectedFilters }" :facetsIds="[facet.id]">
                  <span :data-test="`${facet.label}-selected-filters`">
                    {{ selectedFilters.length }}
                  </span>
                </SelectedFilters>
                <FiltersList v-slot="{ filter }">
                  <SimpleFilter #label :filter="filter" :data-test="`${facet.label}-filter`">
                    <BasePriceFilterLabel
                      v-if="facet.id === 'price'"
                      :filter="filter"
                      format="ii.dd â‚¬"
                      lessThan="Less than {max}"
                      fromTo="From {min} to {max}"
                      from="More than {min}"
                    />
                  </SimpleFilter>
                </FiltersList>
              </SlicedFilters>
            </SortedFilters>
          </ExcludeFiltersWithNoResults>
        </BaseHeaderTogglePanel>
      </template>

      <!--  Default Facet    -->
      <template #default="{ facet }">
        <BaseHeaderTogglePanel headerClass="x-w-full x-flex x-py-8 x-gap-8">
          <template #header-content>
            <span :data-test="facet.label" class="x-truncate">{{ facet.label }}</span>
            <span data-test="total-filters">{{ facet.filters.length }}</span>
            <ChevronDown class="x-ml-auto" />
          </template>

          <!-- Filters -->
          <ExcludeFiltersWithNoResults :filters="facet.filters">
            <SortedFilters>
              <FiltersSearch :data-test="`filters-search-${facet.id}`">
                <SlicedFilters
                  :max="controls.slicedFilters.max"
                  :data-test="`${facet.label}-sliced-filters`"
                >
                  <FiltersList
                    v-slot="{
                      // eslint-disable-next-line vue/no-unused-vars
                      filter
                    }"
                  >
                    <SimpleFilter
                      #label="{ filter }"
                      :filter="filter"
                      :data-test="`${facet.label}-filter`"
                    >
                      {{ filter.label }}
                      <span :data-test="`${facet.label}-filter-total-results`">
                        {{ filter.totalResults }}
                      </span>
                    </SimpleFilter>
                  </FiltersList>
                </SlicedFilters>
              </FiltersSearch>
            </SortedFilters>
          </ExcludeFiltersWithNoResults>
        </BaseHeaderTogglePanel>
      </template>
    </Facets>
  </div>
</template>

<script lang="ts">
  /* eslint-disable max-len */
  import {
    EditableNumberRangeFacet,
    EditableNumberRangeFilter,
    Facet,
    SimpleFilter as SimpleFilterModel
  } from '@empathyco/x-types';
  import { defineComponent } from 'vue';
  import BasePriceFilterLabel from '../../components/filters/labels/base-price-filter-label.vue';
  import EditableNumberPriceRangeFilter from '../../x-modules/facets/components/filters/editable-number-range-filter.vue';
  import ChevronDown from '../../components/icons/chevron-down.vue';
  import BaseHeaderTogglePanel from '../../components/panels/base-header-toggle-panel.vue';
  import ClearFilters from '../../x-modules/facets/components/clear-filters.vue';
  import FacetsProvider from '../../x-modules/facets/components/facets/facets-provider.vue';
  import Facets from '../../x-modules/facets/components/facets/facets.vue';
  import HierarchicalFilter from '../../x-modules/facets/components/filters/hierarchical-filter.vue';
  import SimpleFilter from '../../x-modules/facets/components/filters/simple-filter.vue';
  import ExcludeFiltersWithNoResults from '../../x-modules/facets/components/lists/exclude-filters-with-no-results.vue';
  import FiltersList from '../../x-modules/facets/components/lists/filters-list.vue';
  import FiltersSearch from '../../x-modules/facets/components/lists/filters-search.vue';
  import SelectedFiltersList from '../../x-modules/facets/components/lists/selected-filters-list.vue';
  import SelectedFilters from '../../x-modules/facets/components/lists/selected-filters.vue';
  import SlicedFilters from '../../x-modules/facets/components/lists/sliced-filters.vue';
  import SortedFilters from '../../x-modules/facets/components/lists/sorted-filters.vue';
  import { useHybridInject } from '../../composables';
  import { HomeControls } from './types';
  /* eslint-enable max-len */

  export default defineComponent({
    name: 'Aside',
    components: {
      BaseHeaderTogglePanel,
      BasePriceFilterLabel,
      ChevronDown,
      ClearFilters,
      EditableNumberPriceRangeFilter,
      ExcludeFiltersWithNoResults,
      Facets,
      FacetsProvider,
      FiltersList,
      FiltersSearch,
      HierarchicalFilter,
      SimpleFilter,
      SelectedFilters,
      SelectedFiltersList,
      SlicedFilters,
      SortedFilters
    },
    setup() {
      const controls = useHybridInject<HomeControls>('controls') as HomeControls;
      const editableNumberRangeFilter: EditableNumberRangeFilter = {
        facetId: 'salePrice',
        selected: false,
        id: 'price:0-*',
        modelName: 'EditableNumberRangeFilter',
        range: {
          min: null,
          max: null
        }
      };
      const staticFacets: Facet[] = [
        {
          modelName: 'SimpleFacet',
          label: 'Offer',
          id: 'offer',
          filters: [
            {
              facetId: 'offer',
              modelName: 'SimpleFilter',
              id: 'price:0-10',
              selected: false,
              label: 'price:0-10'
            } as SimpleFilterModel
          ]
        },
        {
          modelName: 'EditableNumberRangeFacet',
          label: 'Price range',
          id: 'salePrice',
          filters: [editableNumberRangeFilter]
        } as EditableNumberRangeFacet
      ];

      return { controls, staticFacets };
    }
  });
</script>

<style scoped lang="scss"></style>
